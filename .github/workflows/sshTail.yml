name: VLESS VPN via Tailscale Funnel

on:
  workflow_dispatch:

jobs:
  vless-vpn:
    runs-on: ubuntu-latest
    steps:
      - name: Update system
        run: sudo apt update -y && sudo apt install -y jq curl

      - name: Install Xray (V2Ray Core)
        run: |
          bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install

      - name: Generate VPN Credentials
        id: credentials
        run: |
          UUID=$(xray uuid)
          echo "UUID=$UUID" >> $GITHUB_ENV
          echo "UUID generated: $UUID"

      - name: Configure Xray Server (VLESS + WS)
        run: |
          cat <<EOF | sudo tee /usr/local/etc/xray/config.json
          {
            "inbounds":,
                "decryption": "none"
              },
              "streamSettings": {
                "network": "ws",
                "wsSettings": {"path": "/vless-ws"}
              }
            }],
            "outbounds": [{"protocol": "freedom"}]
          }
          EOF
          sudo systemctl restart xray

      - name: Install Tailscale
        run: curl -fsSL https://tailscale.com/install.sh | sh

      - name: Connect to Tailscale
        run: |
          sudo tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=github-vless-node \
            --accept-risk=lose-ssh

      - name: Start Tailscale Funnel (TLS Forwarding)
        run: |
          sudo tailscale serve reset
          # فوروارد کردن پورت 443 اینترنت به پورت 8080 محلی (Xray)
          # خودِ Tailscale لایه TLS را با گواهی معتبر هندل می‌کند
          sudo tailscale funnel --bg --tcp 443 8080
          sleep 15

      - name: Show V2Ray Config URL
        run: |
          DNS_NAME=$(tailscale status --json | jq -r '.Self.DNSName' | sed 's/\.$//')
          # ساخت لینک VLESS برای کلاینت
          VLESS_LINK="vless://${{ env.UUID }}@$DNS_NAME:443?encryption=none&security=tls&type=ws&path=%2Fvless-ws#GitHub-VLESS-VPN"
          echo "--------------------------------------------------"
          echo "IMPORT THIS CONFIG INTO V2RAY / NEKORAY:"
          echo ""
          echo "$VLESS_LINK"
          echo ""
          echo "--------------------------------------------------"
          echo "Funnel Status:"
          sudo tailscale funnel status

      - name: Keep Runner Alive
        run: sleep 18000
