name: VLESS VPN via Tailscale Funnel

on:
  workflow_dispatch:

jobs:
  vless-vpn:
    runs-on: ubuntu-latest
    steps:
      - name: Update system
        run: sudo apt update -y && sudo apt install -y jq curl

      - name: Install Xray (V2Ray Core)
        run: |
          # اضافه کردن sudo برای رفع خطای دسترسی
          curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh | sudo bash -s -- install

      - name: Generate VPN Credentials
        id: credentials
        run: |
          UUID=$(xray uuid)
          echo "UUID=$UUID" >> $GITHUB_ENV
          echo "UUID generated: $UUID"

      - name: Configure Xray Server (VLESS + WS)
        run: |
          # ایجاد کانفیگ کامل و صحیح Xray
          cat <<EOF | sudo tee /usr/local/etc/xray/config.json
          {
            "inbounds": [{
              "port": 8080,
              "protocol": "vless",
              "settings": {
                "clients": [{"id": "${{ env.UUID }}"}],
                "decryption": "none"
              },
              "streamSettings": {
                "network": "ws",
                "wsSettings": {"path": "/vless-ws"}
              }
            }],
            "outbounds": [{"protocol": "freedom"}]
          }
          EOF
          sudo systemctl restart xray

      - name: Install Tailscale
        run: curl -fsSL https://tailscale.com/install.sh | sh

      - name: Connect to Tailscale
        run: |
          sudo tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=github-vless-node \
            --accept-risk=lose-ssh

      - name: Start Tailscale Funnel (TLS Forwarding)
        run: |
          sudo tailscale serve reset --yes || true
          
          # فوروارد کردن پورت 443 اینترنت به پورت 8080 محلی (Xray)
          # استفاده از پروتکل tcp برای جلوگیری از تداخل لایه 7
          sudo tailscale funnel --bg 443 tcp 8080
          
          echo "Waiting for Funnel to initialize..."
          sleep 20

      - name: Show V2Ray Config URL
        run: |
          DNS_NAME=$(tailscale status --json | jq -r '.Self.DNSName' | sed 's/\.$//')
          # ساخت لینک VLESS با تنظیمات صحیح TLS (چون Funnel خودش TLS را هندل می‌کند)
          VLESS_LINK="vless://${{ env.UUID }}@$DNS_NAME:443?encryption=none&security=tls&type=ws&path=%2Fvless-ws#GitHub-VLESS-VPN"
          
          echo "--------------------------------------------------"
          echo "IMPORT THIS CONFIG INTO V2RAYN / NEKORAY:"
          echo ""
          echo "$VLESS_LINK"
          echo ""
          echo "--------------------------------------------------"
          echo "Funnel Status:"
          sudo tailscale funnel status
          echo "--------------------------------------------------"

      - name: Keep Runner Alive
        run: sleep 18000
