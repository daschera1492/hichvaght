name: Ubuntu 5h with Tailscale Exit Node

on:
  workflow_dispatch:

jobs:
  ubuntu-tailscale:
    runs-on: ubuntu-latest
    timeout-minutes: 300   # 5 Ø³Ø§Ø¹Øª

    steps:
      - name: Update system
        run: |
          sudo apt update

      - name: Install prerequisites
        run: |
          sudo apt install -y curl lsb-release iptables

      - name: Add Tailscale GPG key
        run: |
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/$(lsb_release -cs).noarmor.gpg \
          | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null

      - name: Add Tailscale repository
        run: |
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/$(lsb_release -cs).tailscale-keyring.list \
          | sudo tee /etc/apt/sources.list.d/tailscale.list

      - name: Install Tailscale
        run: |
          sudo apt-get update
          sudo apt-get install -y tailscale

      - name: Enable IP forwarding
        run: |
          echo 'net.ipv4.ip_forward = 1' | sudo tee /etc/sysctl.d/99-tailscale.conf
          echo 'net.ipv6.conf.all.forwarding = 1' | sudo tee -a /etc/sysctl.d/99-tailscale.conf
          sudo sysctl -p /etc/sysctl.d/99-tailscale.conf

      - name: Start tailscaled
        run: |
          sudo systemctl enable --now tailscaled

      - name: Tailscale login (WAIT HERE)
        run: |
          echo "============================================"
          echo "ðŸ”— Login URL will appear below."
          echo "ðŸ‘‰ Click it, login, then return here."
          echo "============================================"
          sudo tailscale up

      - name: Advertise exit node
        run: |
          sudo tailscale set --advertise-exit-node

      - name: Configure iptables
        run: |
          sudo iptables -A FORWARD -i tailscale0 -o eth0 -j ACCEPT
          sudo iptables -A FORWARD -i eth0 -o tailscale0 -m state --state RELATED,ESTABLISHED -j ACCEPT
          sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

      - name: Tailscale status
        run: |
          tailscale status

      - name: Keep runner alive (5 hours)
        run: |
          echo "Runner is ready. Keeping it alive..."
          sleep 18000
